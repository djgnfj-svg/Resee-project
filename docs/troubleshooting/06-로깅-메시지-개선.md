# 로깅 메시지 개선 회고

> 2025년 10월, 디버깅을 쉽게 만드는 로깅 전략

## 개요

- **문제 발견**: 2025년 10월
- **해결 완료**: 같은 날 (45분 소요)
- **원인**: 에러 로깅에 스택 트레이스가 없어서 디버깅이 어려움

---

## 문제 발견

AI 서비스에서 간헐적으로 에러가 발생했는데, 로그만 봐서는 원인을 알 수 없었다.

```python
# backend/review/ai_evaluation.py:81
except Exception as e:
    logger.error(f"AI 답변 평가 실패: {content_title} - {e}")
    # 스택 트레이스가 없어서 어디서 에러가 났는지 모름
```

로그 출력:
```
ERROR AI 답변 평가 실패: Python Basics - 'text'
```

**문제점**:
- 어떤 줄에서 에러가 났는지 모름
- KeyError인지 AttributeError인지 알 수 없음
- 호출 스택을 볼 수 없음

---

## 원인 분석

### 발견된 문제들

| 위치 | 문제 | 영향도 |
|------|------|--------|
| `content/ai_validation.py:94` | exc_info=True 누락 | 높음 (외부 API) |
| `content/ai_validation.py:127` | exc_info=True 누락 | 높음 (파싱 에러) |
| `review/ai_evaluation.py:81` | exc_info=True 누락 | 높음 (평가 실패) |
| `review/ai_evaluation.py:152-158` | 예외 타입별 구분 부족 | 중간 |
| `review/ai_evaluation.py:196` | JSON 파싱 에러 처리 부족 | 중간 |

### 왜 문제인가?

**1. 스택 트레이스 없이는 디버깅이 불가능**

```python
# 이렇게만 로깅하면
logger.error(f"AI validation failed: {str(e)}")

# 로그
ERROR: AI validation failed: 'text'

# 🤔 뭐가 문제지?
# - 어디서 에러가 났는지 모름
# - 변수값을 모름
# - 호출 경로를 모름
```

**2. 에러 타입별로 다르게 처리해야 함**

```python
# 모든 예외를 똑같이 처리하면
except Exception as e:
    logger.error(f"API 호출 실패: {e}")

# 실제로는 이렇게 구분해야 함
except anthropic.AuthenticationError:  # 설정 문제
except anthropic.RateLimitError:       # 일시적 문제
except anthropic.APIConnectionError:    # 네트워크 문제
```

**3. 컨텍스트 정보 부족**

```python
# 이건 정보가 부족함
logger.error("AI validation failed")

# 이게 디버깅에 유용함
logger.error(f"AI validation failed for title '{title[:50]}...': {e}", exc_info=True)
```

---

## 해결 과정

### 1단계: exc_info=True 추가

**Before**:
```python
except Exception as e:
    logger.error(f"AI validation failed: {str(e)}")
```

**After**:
```python
except Exception as e:
    logger.error(f"AI validation failed for title '{title[:50]}...': {str(e)}", exc_info=True)
```

**결과**:
```
ERROR: AI validation failed for title 'Python Basics': 'text'
Traceback (most recent call last):
  File "ai_validation.py", line 87, in validate_content
    response_text = message.content[0].text.strip()
KeyError: 'text'
```

이제 **정확히 어디서** 에러가 났는지 알 수 있다!

---

### 2단계: 예외 타입별 로깅 레벨 조정

AI API 호출 시 예외를 구체적으로 처리했다.

**Before**:
```python
except Exception as e:
    logger.error(f"Claude API 호출 실패: {e}")
    return None
```

**After**:
```python
except anthropic.AuthenticationError as e:
    # 설정 문제 - 즉시 수정 필요
    logger.error(f"AI API 인증 실패: {e}", exc_info=True)
    return None
except anthropic.RateLimitError as e:
    # 일시적 문제 - 재시도하면 됨
    logger.warning(f"AI API 요청 한도 초과 (일시적 제한): {e}")
    return None
except anthropic.APIConnectionError as e:
    # 네트워크 문제
    logger.error(f"AI API 연결 실패 (네트워크 문제): {e}")
    return None
except anthropic.APITimeoutError as e:
    # 서버 지연 - 일시적
    logger.warning(f"AI API 타임아웃 (서버 응답 지연): {e}")
    return None
except Exception as e:
    # 예상 못한 에러
    logger.error(f"Claude API 호출 실패: {e}", exc_info=True)
    return None
```

**장점**:
- 로그 레벨로 심각도 구분 (ERROR vs WARNING)
- 에러 메시지로 원인 파악 가능
- 일시적 문제는 WARNING으로 알림 피로 감소

---

### 3단계: 컨텍스트 정보 추가

**Before**:
```python
logger.error(f"Failed to parse validation response: {str(e)}")
```

**After**:
```python
logger.error(f"Failed to parse validation response: {str(e)}", exc_info=True)
logger.debug(f"Raw response text: {response_text[:500]}...")
```

**장점**:
- DEBUG 레벨로 원본 응답 확인 가능
- 프로덕션에서는 DEBUG 로그를 끄면 됨
- 개발 중에는 전체 응답을 볼 수 있음

---

### 4단계: JSON 파싱 에러 개선

**Before**:
```python
except Exception as e:
    logger.error(f"응답 처리 실패: {e}")
    return None
```

**After**:
```python
except json.JSONDecodeError as e:
    logger.error(f"JSON 파싱 실패: {e} - 응답: {response[:200]}", exc_info=True)
    return None
except (ValueError, KeyError) as e:
    logger.error(f"응답 데이터 검증 실패: {e}")
    return None
except Exception as e:
    logger.error(f"응답 처리 실패: {e}", exc_info=True)
    return None
```

**장점**:
- JSON 파싱 에러와 데이터 검증 에러를 구분
- 파싱 실패 시 원본 응답 일부를 로그에 포함
- 각 에러 타입에 맞는 메시지

---

## 배운 점

### 1. exc_info=True는 필수

```python
# ❌ 나쁨: 스택 트레이스 없음
logger.error(f"Error: {e}")

# ✅ 좋음: 스택 트레이스 포함
logger.error(f"Error: {e}", exc_info=True)

# ✅ 더 좋음: 컨텍스트 + 스택 트레이스
logger.error(f"Failed to process {item_id}: {e}", exc_info=True)
```

**언제 사용?**
- 에러 원인을 찾아야 할 때 (거의 항상)
- 외부 API 호출 실패
- 데이터 파싱 에러
- 예상하지 못한 Exception

**언제 생략?**
- 예상된 에러이고 복구 가능한 경우
- 로그가 너무 많아질 때 (하지만 이것도 신중하게)

---

### 2. 로깅 레벨 선택 가이드

| 레벨 | 용도 | 예시 |
|------|------|------|
| **DEBUG** | 개발 중 상세 정보 | 원본 API 응답, 쿼리 실행 시간 |
| **INFO** | 정상 동작 확인 | 사용자 로그인, 결제 성공 |
| **WARNING** | 주의 필요 (복구 가능) | API 요청 한도, 캐시 미스 |
| **ERROR** | 에러 발생 (기능 실패) | DB 연결 실패, API 인증 실패 |
| **CRITICAL** | 심각한 에러 (서비스 다운) | 메모리 부족, 디스크 풀 |

**실전 예시**:
```python
# Rate limit - 일시적이므로 WARNING
except anthropic.RateLimitError as e:
    logger.warning(f"API 요청 한도 초과: {e}")

# Authentication - 설정 문제이므로 ERROR
except anthropic.AuthenticationError as e:
    logger.error(f"API 인증 실패: {e}", exc_info=True)

# Timeout - 재시도하면 되므로 WARNING
except anthropic.APITimeoutError as e:
    logger.warning(f"API 타임아웃: {e}")

# Connection - 네트워크 문제이므로 ERROR
except anthropic.APIConnectionError as e:
    logger.error(f"API 연결 실패: {e}")
```

---

### 3. 컨텍스트 정보 포함하기

```python
# ❌ 나쁨: 컨텍스트 없음
logger.error("Validation failed")

# ⚠️ 보통: 기본 정보만
logger.error(f"Validation failed: {e}")

# ✅ 좋음: 무엇을 처리하다가 실패했는지
logger.error(f"Validation failed for content {content_id}: {e}")

# ✅✅ 최고: 디버깅에 필요한 모든 정보
logger.error(
    f"AI validation failed for user {user.email}, "
    f"title '{title[:50]}...', "
    f"content_length={len(content)}: {e}",
    exc_info=True
)
```

**포함하면 좋은 정보**:
- 사용자 식별자 (user.email, user.id)
- 처리 중인 데이터 ID (content_id, order_id)
- 요청 메타데이터 (IP, user-agent)
- 비즈니스 컨텍스트 (결제 금액, 티어 등)

**주의**: 민감 정보는 로깅하지 않기
- 비밀번호
- API 키
- 개인정보 (주민번호, 카드번호)

---

### 4. 개발 vs 프로덕션 로깅

**개발 환경**:
```python
# settings/development.py
LOGGING = {
    'loggers': {
        'django': {'level': 'DEBUG'},
        'review': {'level': 'DEBUG'},
    }
}
```

**프로덕션 환경**:
```python
# settings/production.py
LOGGING = {
    'loggers': {
        'django': {'level': 'INFO'},
        'review': {'level': 'INFO'},
    }
}
```

**코드에서**:
```python
# DEBUG는 프로덕션에서 안 보임
logger.debug(f"Raw API response: {response}")

# INFO는 항상 보임
logger.info(f"User {user.email} upgraded to PRO")

# ERROR는 반드시 보임
logger.error(f"Payment failed: {e}", exc_info=True)
```

---

### 5. 로깅 안티패턴

**❌ 나쁨: 에러 무시**
```python
except Exception:
    pass  # 에러 발생을 숨김
```

**❌ 나쁨: print() 사용**
```python
except Exception as e:
    print(f"Error: {e}")  # 로그 파일에 안 남음
```

**❌ 나쁨: 너무 많은 정보**
```python
logger.debug(f"Full response: {response}")  # 10MB 응답을 로그에...
```

**✅ 좋음: 적절한 크기로 자르기**
```python
logger.debug(f"Response preview: {response[:500]}...")
```

---

## 체크리스트

로깅 작성 시:

- [ ] 에러 로깅에 `exc_info=True` 포함했는가?
- [ ] 로깅 레벨이 적절한가? (DEBUG/INFO/WARNING/ERROR)
- [ ] 컨텍스트 정보를 포함했는가? (user, item_id 등)
- [ ] 민감 정보를 로깅하지 않았는가?
- [ ] 너무 큰 데이터를 로깅하지 않았는가?
- [ ] 예외 타입별로 적절하게 처리했는가?

코드 리뷰 시:

- [ ] `except Exception`만 쓰지 않고 구체적인 예외를 잡는가?
- [ ] 로그 메시지만 봐도 무슨 일이 일어났는지 이해할 수 있는가?
- [ ] 프로덕션에서 DEBUG 로그가 너무 많이 찍히지 않는가?

---

## 개선 결과

### Before
```
ERROR: AI validation failed: 'text'
ERROR: Claude API 호출 실패: Connection refused
ERROR: JSON 파싱 실패: Expecting value
```

**문제점**: 어디서 에러가 났는지, 왜 났는지 알 수 없음

### After
```
ERROR: AI validation failed for title 'Python Basics...': 'text'
Traceback (most recent call last):
  File "ai_validation.py", line 87, in validate_content
    response_text = message.content[0].text.strip()
KeyError: 'text'

ERROR: AI API 연결 실패 (네트워크 문제): Connection refused
WARNING: AI API 요청 한도 초과 (일시적 제한): Rate limit exceeded

ERROR: JSON 파싱 실패: Expecting value - 응답: {"invalid": ...}
Traceback (most recent call last):
  ...
```

**개선 사항**:
- 스택 트레이스로 정확한 위치 파악
- 에러 타입별로 적절한 로깅 레벨
- 컨텍스트 정보로 원인 추적 가능

---

## 관련 코드

- 수정한 파일:
  * `backend/content/ai_validation.py:94, 127`
  * `backend/review/ai_evaluation.py:81, 152-164, 202-207`
- 커밋: (다음 단계에서 생성)

---

## 참고한 자료

- [Python Logging HOWTO](https://docs.python.org/3/howto/logging.html)
- [Django Logging](https://docs.djangoproject.com/en/4.2/topics/logging/)
- [Real Python - Logging in Python](https://realpython.com/python-logging/)

---

## 정리

45분 동안 AI 서비스 로깅을 개선했다.

**변경 사항**:
- `exc_info=True` 추가로 스택 트레이스 포함
- 예외 타입별로 구체적인 처리
- 컨텍스트 정보 추가 (title, content_id 등)
- DEBUG 로그로 원본 응답 확인 가능

**다음에 적용할 점**:
- 에러 로깅은 항상 `exc_info=True`
- 예외 타입별로 적절한 로깅 레벨 선택
- 컨텍스트 정보 포함 (하지만 민감 정보는 제외)
- 너무 큰 데이터는 잘라서 로깅

**신입 개발자를 위한 조언**:
> "로그는 미래의 당신을 위한 메시지입니다.
> 3개월 뒤에 이 에러를 봤을 때 이해할 수 있도록 작성하세요."
