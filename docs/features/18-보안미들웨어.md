# 보안 미들웨어

## 핵심 개념

**3개의 보안 미들웨어**로 애플리케이션을 보호합니다.
보안 헤더, 요청 로깅, SQL 인젝션 탐지를 통해 다층 방어를 제공합니다.

## 주요 기능

- **보안 헤더 미들웨어** (SecurityHeadersMiddleware):
  - X-Content-Type-Options: nosniff
  - X-Frame-Options: DENY
  - X-XSS-Protection: 1; mode=block
  - Referrer-Policy: strict-origin-when-cross-origin
  - Content-Security-Policy 설정
  - Server 헤더 제거
- **요청 로깅 미들웨어** (RequestLoggingMiddleware):
  - 느린 요청 탐지 (1초 초과)
  - API 에러 로깅 (400 이상)
  - 응답 시간 측정
- **SQL 인젝션 탐지** (SQLInjectionDetectionMiddleware):
  - 10개 패턴 감지
  - GET/POST 파라미터 검사
  - 공격 시도 로깅 및 차단

## 동작 흐름

```
[보안 헤더]
1. 응답 생성
   ↓
2. process_response 호출
   ↓
3. 프로덕션 환경 확인
   ↓
4. 보안 헤더 추가
   ↓
5. Server 헤더 제거

[요청 로깅]
1. 요청 수신 → start_time 기록
   ↓
2. 요청 처리
   ↓
3. 응답 생성 → duration 계산
   ↓
4. 1초 초과 시 경고 로그
   ↓
5. API 에러 시 에러 로그

[SQL 인젝션 탐지]
1. 요청 수신
   ↓
2. GET/POST 파라미터 추출
   ↓
3. 각 값에 대해 10개 패턴 검사
   ↓
4. 패턴 매칭 시:
   - CRITICAL 로그 기록
   - 403 응답 반환 ("잘못된 요청입니다.")
```

## SQL 인젝션 패턴

```python
SQL_INJECTION_PATTERNS = [
    r"(\bunion\b.*\bselect\b)|(\bselect\b.*\bunion\b)",
    r"(\bdrop\b.*\btable\b)|(\btable\b.*\bdrop\b)",
    r"(\binsert\b.*\binto\b)|(\binto\b.*\binsert\b)",
    r"(\bdelete\b.*\bfrom\b)|(\bfrom\b.*\bdelete\b)",
    r"(\bupdate\b.*\bset\b)|(\bset\b.*\bupdate\b)",
    r"(\bexec\b.*\bsp_\b)|(\bsp_\b.*\bexec\b)",
    r"(\bor\b.*1.*=.*1)|(\band\b.*1.*=.*1)",
    r"(\bor\b.*'.*'.*=.*'.*')|(\band\b.*'.*'.*=.*'.*')",
    r"(\b--)|(\b#)|(\b/\*.*\*/)",
    r"(\bxp_cmdshell\b)|(\bsp_executesql\b)",
]
```

## Content Security Policy

```
default-src 'self'
script-src 'self' 'unsafe-inline' 'unsafe-eval'
style-src 'self' 'unsafe-inline'
img-src 'self' data: https:
font-src 'self' data:
connect-src 'self' https:
frame-ancestors 'none'
```

## 관련 파일

- `backend/resee/middleware.py` - 3개 미들웨어 정의
- `backend/resee/settings/base.py` - 미들웨어 등록

## 미들웨어 등록

```python
# backend/resee/settings/base.py
MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'corsheaders.middleware.CorsMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',

    # 커스텀 미들웨어
    'resee.middleware.SecurityHeadersMiddleware',
    'resee.middleware.RequestLoggingMiddleware',
    'resee.middleware.SQLInjectionDetectionMiddleware',
]
```

## 로그 예시

**느린 요청 로그**:
```
WARNING Slow request: GET /api/review/today/ took 1.35s - Status: 200
```

**API 에러 로그**:
```
ERROR API error: POST /api/content/ - Status: 400 - User: user@example.com - Duration: 0.12s
```

**SQL 인젝션 시도 로그**:
```
CRITICAL SQL injection attempt detected in GET param 'search': ' OR 1=1 --
```

## 보안 헤더 효과

- **X-Content-Type-Options**: MIME 타입 스니핑 방지
- **X-Frame-Options**: 클릭재킹 방지 (iframe 차단)
- **X-XSS-Protection**: XSS 공격 탐지 및 차단
- **Referrer-Policy**: Referer 정보 제한
- **Content-Security-Policy**: XSS, 데이터 인젝션 방어
- **Server 헤더 제거**: 서버 정보 노출 방지

## 환경별 적용

보안 헤더는 **staging/production 환경에서만** 적용됩니다.

```python
if getattr(settings, 'ENVIRONMENT', 'development') in ['staging', 'production']:
    # 보안 헤더 추가
```

## 성능 모니터링

RequestLoggingMiddleware는 모든 요청의 응답 시간을 측정하여 성능 병목 지점을 식별합니다.

```python
duration = time.time() - request.start_time
if duration > 1.0:
    logger.warning(f"Slow request: {request.method} {request.path} took {duration:.2f}s")
```

## 확장 가능성

추가 가능한 미들웨어:
- Rate limiting middleware (현재는 DRF throttling 사용)
- User-Agent 분석 미들웨어
- Geographic IP 차단 미들웨어
- API 버전 체크 미들웨어
