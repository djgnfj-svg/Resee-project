# 법적 준수 시스템

## 핵심 개념

**GDPR 데이터 권리 보장**을 위한 법적 준수 시스템입니다.
사용자의 데이터 이동권과 삭제권을 완전히 지원하며, 동의 관리 및 쿠키 설정을 제공합니다.

## 주요 기능

- **GDPR 권리 보장**:
  - Right to be Forgotten (데이터 삭제 요청)
  - Right to Data Portability (데이터 내보내기)
  - Consent Withdrawal (동의 철회)
- **동의 관리**:
  - 이용약관, 개인정보 처리방침 동의 기록
  - IP 주소 및 User Agent 수집
  - 동의 버전 관리
- **쿠키 관리**:
  - 필수/분석/마케팅/기능성 쿠키 분류
  - 회원/비회원 동의 상태 관리
  - 세션 기반 동의 기록

## 동작 흐름

```
[데이터 삭제 요청]
1. 사용자가 데이터 삭제 요청
   ↓
2. DataDeletionRequest 생성 (상태: pending)
   ↓
3. 관리자 검토
   ↓
4. 데이터 삭제 처리 (계정 포함)

[데이터 내보내기]
1. 사용자가 내보내기 요청
   ↓
2. DataExportRequest 생성
   ↓
3. JSON 파일 생성 (개인정보, 콘텐츠, 복습 이력)
   ↓
4. 다운로드 링크 제공 (7일간 유효)
   ↓
5. 만료 후 자동 삭제

[동의 관리]
1. 회원가입 시 이용약관/개인정보 동의
   ↓
2. UserConsent 기록 (IP, User Agent, 버전)
   ↓
3. 사용자 언제든지 동의 철회 가능
   ↓
4. 철회 시 새 동의 기록 생성 (is_consented=False)
```

## API

- `GET /api/accounts/legal/documents/` - 법적 문서 목록
- `GET /api/accounts/legal/documents/{type}/` - 법적 문서 상세
- `GET /api/accounts/legal/consents/` - 동의 기록 조회
- `POST /api/accounts/legal/consents/` - 동의 생성/업데이트
- `POST /api/accounts/legal/withdraw-consent/` - 동의 철회
- `POST /api/accounts/legal/data-deletion/` - 데이터 삭제 요청
- `GET /api/accounts/legal/data-deletion/` - 삭제 요청 상태
- `POST /api/accounts/legal/data-export/` - 데이터 내보내기 요청
- `GET /api/accounts/legal/data-export/` - 내보내기 요청 상태
- `GET /api/accounts/legal/data-export/{id}/download/` - 데이터 다운로드
- `GET /api/accounts/legal/cookie-consent/` - 쿠키 동의 조회
- `POST /api/accounts/legal/cookie-consent/` - 쿠키 동의 설정
- `GET /api/accounts/legal/gdpr-summary/` - GDPR 데이터 요약

## 관련 파일

- `backend/accounts/legal/legal_models.py` - 5개 모델 (LegalDocument, UserConsent, DataDeletionRequest, DataExportRequest, CookieConsent)
- `backend/accounts/legal/legal_views.py` - 법적 준수 API
- `backend/accounts/legal/legal_serializers.py` - 직렬화 클래스
- `backend/accounts/utils/utils.py` - IP/User Agent 수집

## 데이터 모델

```python
# 법적 문서
class LegalDocument(models.Model):
    document_type = models.CharField(max_length=50)  # terms/privacy
    version = models.CharField(max_length=20)
    content = models.TextField()
    is_active = models.BooleanField(default=True)

# 사용자 동의
class UserConsent(models.Model):
    user = models.ForeignKey(User)
    consent_type = models.CharField(max_length=50)
    document_version = models.CharField(max_length=20)
    is_consented = models.BooleanField()
    ip_address = models.GenericIPAddressField()
    user_agent = models.TextField()
    consented_at = models.DateTimeField(auto_now_add=True)

# 데이터 삭제 요청
class DataDeletionRequest(models.Model):
    user = models.ForeignKey(User)
    reason = models.TextField()
    status = models.CharField(max_length=20)  # pending/in_progress/completed
    requested_at = models.DateTimeField(auto_now_add=True)

# 데이터 내보내기 요청
class DataExportRequest(models.Model):
    user = models.ForeignKey(User)
    status = models.CharField(max_length=20)  # pending/processing/ready/downloaded/expired
    file_path = models.CharField(max_length=255)
    expires_at = models.DateTimeField()  # 7일 후
    downloaded_at = models.DateTimeField(null=True)

# 쿠키 동의
class CookieConsent(models.Model):
    user = models.ForeignKey(User, null=True)  # 비회원은 session_id 사용
    session_id = models.CharField(max_length=255, null=True)
    essential_cookies = models.BooleanField(default=True)
    analytics_cookies = models.BooleanField(default=False)
    marketing_cookies = models.BooleanField(default=False)
    functional_cookies = models.BooleanField(default=False)
    ip_address = models.GenericIPAddressField()
    user_agent = models.TextField()
```

## GDPR 준수 요소

1. **투명성**: 모든 법적 문서 공개 및 버전 관리
2. **동의**: 명시적 동의 수집 및 기록 (IP, User Agent, 시간)
3. **접근권**: 사용자 본인 데이터 조회 API
4. **이동권**: JSON 형식 데이터 내보내기
5. **삭제권**: 데이터 삭제 요청 워크플로우
6. **동의 철회**: 선택적 동의 철회 지원
7. **쿠키 정책**: 쿠키 분류 및 동의 관리
