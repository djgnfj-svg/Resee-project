# 관리자 커스터마이징

## 핵심 개념

**Django Admin 최적화**로 10개 이상의 모델을 효율적으로 관리합니다.
색상 코딩, 일괄 작업, CSV 내보내기, 필터링으로 관리자 경험을 향상시킵니다.

## 주요 기능

- **색상 코딩**:
  - 구독 등급별 색상 (FREE: 회색, BASIC: 파랑, PRO: 초록)
  - 상태별 색상 구분
- **일괄 작업** (Bulk Actions):
  - 이메일 일괄 인증
  - 환영 이메일 일괄 발송
  - CSV 내보내기
- **고급 필터링**:
  - 날짜 범위 필터
  - 구독 등급 필터
  - 이메일 인증 여부 필터
- **검색 기능**:
  - 이메일, 사용자명, 이름 검색
  - 관계형 필드 검색
- **커스텀 display 메서드**:
  - subscription_tier: 색상 코딩된 구독 등급
  - 관계형 데이터 표시

## 동작 흐름

```
[일괄 이메일 인증]
1. 관리자가 사용자 선택
   ↓
2. "Verify selected user emails" 액션 선택
   ↓
3. is_email_verified=False 필터링
   ↓
4. 트랜잭션 시작
   ↓
5. 이메일 인증 상태 업데이트
   ↓
6. 인증 토큰 제거
   ↓
7. 성공 메시지 표시

[CSV 내보내기]
1. 사용자 선택
   ↓
2. "Export selected users to CSV" 선택
   ↓
3. CSV 헤더 생성
   ↓
4. 각 사용자 데이터 추가
   ↓
5. HTTP 응답으로 파일 다운로드
```

## 등록된 모델

```python
# 10개 이상의 모델 등록
@admin.register(User)
@admin.register(Subscription)
@admin.register(SubscriptionTier)
@admin.register(PaymentHistory)
@admin.register(Content)
@admin.register(ReviewSchedule)
@admin.register(ReviewHistory)
@admin.register(WeeklyTest)
@admin.register(Question)
@admin.register(Answer)
# 등등...
```

## 사용자 관리 커스터마이징

```python
@admin.register(User)
class CustomUserAdmin(UserAdmin):
    list_display = (
        'email',
        'username',
        'subscription_tier',  # 색상 코딩
        'is_email_verified',
        'weekly_goal',
        'is_active',
        'date_joined'
    )

    list_filter = (
        'is_email_verified',
        'subscription__tier',
        ('date_joined', admin.DateFieldListFilter),
        ('last_login', admin.DateFieldListFilter),
    )

    search_fields = ['email', 'username', 'first_name', 'last_name']

    actions = [
        'bulk_verify_email',
        'bulk_send_welcome_email',
        'export_users_csv',
    ]
```

## 색상 코딩 구현

```python
def subscription_tier(self, obj):
    """구독 등급 색상 표시"""
    if hasattr(obj, 'subscription') and obj.subscription:
        tier = obj.subscription.tier
        colors = {
            'free': '#6c757d',    # 회색
            'basic': '#007bff',   # 파랑
            'pro': '#28a745'      # 초록
        }
        color = colors.get(tier, '#6c757d')
        return format_html(
            '<span style="color: {}; font-weight: bold;">{}</span>',
            color,
            obj.subscription.get_tier_display()
        )
    return format_html('<span style="color: #dc3545;">No Subscription</span>')
```

## 일괄 작업 구현

```python
def bulk_verify_email(self, request, queryset):
    """이메일 일괄 인증"""
    with transaction.atomic():
        updated = queryset.filter(is_email_verified=False).update(
            is_email_verified=True,
            email_verification_token=None,
            email_verification_sent_at=None
        )

    self.message_user(
        request,
        f'Successfully verified {updated} user emails.',
        messages.SUCCESS
    )

def export_users_csv(self, request, queryset):
    """CSV 내보내기"""
    import csv
    from django.http import HttpResponse

    response = HttpResponse(content_type='text/csv')
    response['Content-Disposition'] = 'attachment; filename="users.csv"'

    writer = csv.writer(response)
    writer.writerow(['Email', 'Username', 'Subscription', 'Verified', 'Joined'])

    for user in queryset:
        tier = user.subscription.tier if hasattr(user, 'subscription') else 'N/A'
        writer.writerow([
            user.email,
            user.username,
            tier,
            user.is_email_verified,
            user.date_joined.strftime('%Y-%m-%d')
        ])

    return response
```

## 관련 파일

- `backend/accounts/admin.py` - User, Subscription 관리
- `backend/content/admin.py` - Content 관리
- `backend/review/admin.py` - ReviewSchedule, ReviewHistory 관리
- `backend/weekly_test/admin.py` - WeeklyTest, Question, Answer 관리
- `backend/analytics/admin.py` - Analytics 관리

## Admin 인터페이스 기능

1. **사용자 관리**:
   - 구독 등급 색상 표시
   - 이메일 인증 상태
   - 주간 목표 설정
   - 일괄 이메일 인증
   - CSV 내보내기

2. **콘텐츠 관리**:
   - 작성자별 필터
   - 카테고리별 필터
   - 생성 날짜 필터

3. **복습 관리**:
   - 사용자별 스케줄 조회
   - 간격 인덱스 확인
   - 활성 상태 필터

4. **결제 관리**:
   - 결제 이력 조회
   - 결제 유형 필터 (upgrade/downgrade/cancellation)
   - 구독 등급 변경 추적

## 성능 최적화

```python
list_select_related = ['subscription', 'subscription__tier']
list_per_page = 50
```

- `select_related`: N+1 쿼리 방지
- `list_per_page`: 페이지당 항목 수 제한

## 접근 제어

Django Admin은 기본적으로 `is_staff=True` 사용자만 접근 가능합니다.

```python
# 슈퍼유저만 특정 모델 접근
class SensitiveModelAdmin(admin.ModelAdmin):
    def has_module_permission(self, request):
        return request.user.is_superuser
```

## 확장 가능성

추가 가능한 기능:
- 고급 통계 대시보드
- 차트/그래프 통합
- 일괄 이메일 발송 (템플릿 선택)
- 사용자 활동 로그 조회
- 자동화된 보고서 생성
- API 사용량 모니터링 인터페이스
