# 고급 밸리데이션

## 핵심 개념

**15개 이상의 밸리데이터**로 입력 데이터의 무결성을 보장합니다.
필드 검증, 도메인 차단, 구독 일관성 검증, 외래키 검증 등 다층적인 검증 시스템을 제공합니다.

## 주요 기능

- **기본 밸리데이션**:
  - validate_required_fields: 필수 필드 검증
  - validate_choice_field: 선택 필드 검증
  - validate_positive_integer: 양의 정수 검증
- **도메인 밸리데이션**:
  - validate_email_domain: 일회용 이메일 차단 (7개 도메인)
  - validate_username: 사용자명 형식 검증
  - validate_category_name: 카테고리명 검증
- **비즈니스 로직 밸리데이션**:
  - validate_subscription_tier_consistency: 구독 등급 변경 검증
  - validate_review_interval_index: 복습 간격 인덱스 검증
  - validate_content_length: 콘텐츠 길이 검증 (1-50,000자)
  - validate_weekly_goal: 주간 목표 검증 (1-50)
- **데이터 무결성 밸리데이션**:
  - DataIntegrityValidator.validate_user_subscription_consistency
  - DataIntegrityValidator.validate_review_schedule_consistency
  - DataIntegrityValidator.validate_payment_consistency
- **데이터베이스 제약 밸리데이션**:
  - validate_foreign_key_exists: 외래키 존재 검증
  - validate_unique_together: unique_together 제약 검증

## 동작 흐름

```
[이메일 도메인 차단]
1. 사용자 회원가입 시도
   ↓
2. validate_email_domain(email) 호출
   ↓
3. 도메인 추출 (@ 뒤)
   ↓
4. 차단 목록 확인
   ↓
5. 차단 도메인이면 ValidationError 발생

[구독 일관성 검증]
1. 사용자가 구독 등급 변경
   ↓
2. validate_subscription_tier_consistency() 호출
   ↓
3. 현재 등급과 새 등급 비교
   ↓
4. 다운그레이드 시 로그 기록
   ↓
5. 의심스러운 패턴 감지

[데이터 무결성 검증]
1. ReviewSchedule 저장 전
   ↓
2. DataIntegrityValidator.validate_review_schedule_consistency() 호출
   ↓
3. 여러 규칙 검증:
   - 복습 간격 인덱스가 구독 범위 내인가?
   - 다음 복습 날짜가 생성 날짜보다 후인가?
   - 스케줄 사용자와 콘텐츠 작성자가 일치하는가?
   ↓
4. 모든 에러 수집하여 반환
```

## 사용 예시

```python
# 기본 밸리데이션
from resee.validators import validate_required_fields

data = {'email': 'user@example.com'}
validate_required_fields(data, ['email', 'password'])  # ValidationError 발생

# 이메일 도메인 차단
from resee.validators import validate_email_domain

validate_email_domain('test@tempmail.com')  # ValidationError 발생
validate_email_domain('test@gmail.com')  # 통과

# 콘텐츠 길이 검증
from resee.validators import validate_content_length

validate_content_length('  ')  # ValidationError: 빈 콘텐츠
validate_content_length('a' * 60000)  # ValidationError: 50,000자 초과

# 데이터 무결성 검증
from resee.validators import DataIntegrityValidator

errors = DataIntegrityValidator.validate_review_schedule_consistency(schedule)
if errors:
    for error in errors:
        print(error)

# 데코레이터 사용
from resee.validators import handle_validation_error

@handle_validation_error
def create_review(request):
    # ValidationError가 자동으로 400 응답으로 변환됨
    validate_required_fields(request.data, ['content_id', 'score'])
    return Response({'success': True})
```

## 차단된 이메일 도메인

```python
blocked_domains = [
    'tempmail.com',
    '10minutemail.com',
    'guerrillamail.com',
    'mailinator.com',
    'yopmail.com',
    'throwaway.email',
    'temp-mail.org',
]
```

## 밸리데이터 목록

### 1. 필드 밸리데이션
- **validate_required_fields**: 필수 필드 누락 확인
- **validate_choice_field**: 허용된 선택지 검증
- **validate_positive_integer**: 양의 정수 확인

### 2. 도메인 밸리데이션
- **validate_email_domain**: 일회용 이메일 차단
- **validate_username**: 사용자명 형식 (3-30자, 영숫자/_/./-)
- **validate_category_name**: 카테고리명 (1-100자, 특수문자만 불가)

### 3. 비즈니스 로직 밸리데이션
- **validate_subscription_tier_consistency**: 등급 변경 로그
- **validate_review_interval_index**: 구독 범위 내 간격 검증
- **validate_content_length**: 1-50,000자 제한
- **validate_weekly_goal**: 1-50 범위

### 4. 데이터 무결성 밸리데이션
- **validate_user_subscription_consistency**: 구독 날짜, 금액, 자동갱신 일관성
- **validate_review_schedule_consistency**: 스케줄 날짜, 사용자 일치
- **validate_payment_consistency**: 결제 유형과 등급 변화 일치

### 5. 데이터베이스 제약 밸리데이션
- **validate_foreign_key_exists**: 참조 무결성
- **validate_unique_together**: 복합 유니크 제약

## 관련 파일

- `backend/resee/validators.py` - 모든 밸리데이터 정의

## 커스텀 밸리데이터 클래스

```python
# JSON 필드 밸리데이터
from resee.validators import JSONFieldValidator

validator = JSONFieldValidator(
    required_keys=['name', 'email'],
    optional_keys=['phone', 'address']
)

data = {'name': 'John', 'email': 'john@example.com'}
validator.validate(data)  # 통과

data = {'name': 'John'}  # email 누락
validator.validate(data)  # ValidationError 발생
```

## 에러 처리 데코레이터

```python
from resee.validators import handle_validation_error

@handle_validation_error
def my_view(request):
    # ValidationError가 발생하면 자동으로 400 응답 반환
    # {'error': '에러 메시지'}
    validate_something(request.data)
    return Response({'success': True})
```

## 확장 가능성

새로운 밸리데이터 추가 방법:
1. `resee/validators.py`에 함수 추가
2. `ValidationError` 사용하여 에러 발생
3. `code` 파라미터로 에러 타입 지정
4. 필요시 `BaseValidator` 상속하여 클래스형 밸리데이터 작성
