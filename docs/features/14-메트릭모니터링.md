# 메트릭 모니터링

## 핵심 개념

**실시간 시스템 성능 지표 추적** 시스템입니다.
API 응답 시간, 에러율, 결제 실패, Celery 큐 길이를 모니터링하며, 임계값 초과 시 Slack 알림을 자동으로 발송합니다.

## 주요 기능

- **API 모니터링**:
  - 요청별 응답 시간 추적
  - 에러율 계산 (1시간 슬라이딩 윈도우)
  - P95 응답 시간 측정
  - 엔드포인트별 통계
- **결제 모니터링**:
  - 결제 실패 추적
  - 실패 원인 기록
  - 시간당 실패 건수
- **Celery 모니터링**:
  - 큐 길이 확인
  - 적체 감지
- **알림 쓰로틀링**:
  - 동일 알림 10분 간격 제한
  - 알림 스팸 방지

## 동작 흐름

```
[API 모니터링]
1. API 요청 완료
   ↓
2. metrics_monitor.track_api_request() 호출
   ↓
3. 메트릭 캐시에 저장 (1시간 슬라이딩 윈도우)
   ↓
4. 에러율 및 P95 응답 시간 계산
   ↓
5. 임계값 초과 시 Slack 알림
   - 에러율 > 5%
   - P95 응답 시간 > 2초

[결제 모니터링]
1. 결제 실패 발생
   ↓
2. metrics_monitor.track_payment_failure() 호출
   ↓
3. 실패 기록 캐시에 저장
   ↓
4. 시간당 실패 건수 확인
   ↓
5. 10건 초과 시 Slack 알림

[Celery 모니터링]
1. 정기적으로 큐 길이 확인
   ↓
2. metrics_monitor.check_celery_queue() 호출
   ↓
3. 큐 길이 > 100 시 Slack 알림
```

## 사용 예시

```python
from utils.monitoring import metrics_monitor

# API 요청 추적
metrics_monitor.track_api_request(
    endpoint='/api/review/today/',
    response_time=0.35,
    status_code=200
)

# 결제 실패 추적
metrics_monitor.track_payment_failure(
    reason='Card declined',
    amount=10000
)

# Celery 큐 확인
metrics_monitor.check_celery_queue(
    queue_name='celery',
    queue_length=150
)

# 메트릭 요약 조회
summary = metrics_monitor.get_metrics_summary()
print(summary)
# {
#     'timestamp': 1729411200.0,
#     'api': {
#         '/api/review/today/': {
#             'total_requests': 1250,
#             'error_rate': 1.2,
#             'avg_response_time': 0.287
#         }
#     },
#     'payments': {
#         'failures_last_hour': 3
#     },
#     'celery': {}
# }
```

## 관련 파일

- `backend/utils/monitoring.py` - 메트릭 모니터링 서비스
- `backend/utils/slack_notifications.py` - 알림 전송

## 임계값 설정

```python
class MetricsMonitor:
    ERROR_RATE_THRESHOLD = 5.0          # 에러율 5%
    PAYMENT_FAILURE_THRESHOLD = 10      # 시간당 결제 실패 10건
    CELERY_QUEUE_THRESHOLD = 100        # Celery 큐 100개
    API_RESPONSE_THRESHOLD = 2.0        # P95 응답 시간 2초
    ALERT_THROTTLE_SECONDS = 600        # 알림 쓰로틀링 10분
```

## 메트릭 저장 방식

- **캐시 기반**: Django 캐시 프레임워크 사용
- **슬라이딩 윈도우**: 1시간 단위 메트릭 유지
- **자동 만료**: 1시간 후 자동 삭제
- **경량화**: 메모리 효율적인 리스트 구조

```python
# 메트릭 구조
{
    'timestamp': 1729411200.0,
    'response_time': 0.35,
    'status_code': 200,
    'is_error': False
}
```

## 모니터링 대상 엔드포인트

```python
key_endpoints = [
    '/api/review/today/',      # 복습 조회
    '/api/content/',            # 콘텐츠 목록
    '/api/accounts/login/',     # 로그인
]
```

## 알림 쓰로틀링

동일한 알림이 10분 이내에 중복 발송되지 않도록 방지합니다.
알림 키(예: `error_rate:/api/review/today/`)를 캐시에 저장하여 중복 체크합니다.

```python
def _should_send_alert(self, alert_key: str) -> bool:
    cache_key = f"monitoring:alert:{alert_key}"
    if cache.get(cache_key):
        return False  # 최근에 알림 발송됨

    cache.set(cache_key, True, 600)  # 10분간 쓰로틀링
    return True
```

## 확장 가능성

- 메트릭 저장소를 Redis나 PostgreSQL로 확장 가능
- 대시보드 시각화를 위한 API 제공
- 커스텀 임계값 설정 지원
- 더 많은 메트릭 유형 추가 가능 (DB 쿼리 시간, 캐시 히트율 등)
