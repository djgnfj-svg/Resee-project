# ë°±ì—… ìë™í™”

## í•µì‹¬ ê°œë…

**Celery Beat ê¸°ë°˜ ë°ì´í„°ë² ì´ìŠ¤ ìë™ ë°±ì—…** ì‹œìŠ¤í…œì…ë‹ˆë‹¤.
ë§¤ì¼ ì •í•´ì§„ ì‹œê°„ì— PostgreSQL ë°ì´í„°ë² ì´ìŠ¤ë¥¼ pg_dumpë¡œ ë°±ì—…í•˜ê³ , gzip ì••ì¶•í•˜ì—¬ ì €ì¥í•©ë‹ˆë‹¤.

## ì£¼ìš” ê¸°ëŠ¥

- **ìë™ ë°±ì—…**:
  - Celery Beat ìŠ¤ì¼€ì¤„ëŸ¬ë¡œ ë§¤ì¼ ì‹¤í–‰
  - pg_dumpë¡œ ì „ì²´ ë°ì´í„°ë² ì´ìŠ¤ ë¤í”„
  - gzip ì••ì¶•ìœ¼ë¡œ íŒŒì¼ í¬ê¸° ìµœì†Œí™”
- **ë°±ì—… ëª¨ë‹ˆí„°ë§**:
  - ì„±ê³µ/ì‹¤íŒ¨ ì‹œ Slack ì•Œë¦¼
  - ë°±ì—… íŒŒì¼ í¬ê¸° ê¸°ë¡
  - íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ë°˜ íŒŒì¼ëª…
- **ì¬ì‹œë„ ë¡œì§**:
  - ì‹¤íŒ¨ ì‹œ ìµœëŒ€ 3íšŒ ì¬ì‹œë„
  - íƒ€ì„ì•„ì›ƒ 10ë¶„
  - 5ë¶„ í›„ ì¬ì‹œë„

## ë™ì‘ íë¦„

```
1. Celery Beatê°€ ë§¤ì¼ ì„¤ì •ëœ ì‹œê°„ì— ì‘ì—… ì‹¤í–‰
   â†“
2. PostgreSQL ì—°ê²° ì •ë³´ ê°€ì ¸ì˜¤ê¸°
   â†“
3. pg_dump ëª…ë ¹ ì‹¤í–‰
   â†“
4. gzipìœ¼ë¡œ ì••ì¶•
   â†“
5. /tmp/ ë””ë ‰í† ë¦¬ì— ì €ì¥
   - íŒŒì¼ëª…: {db_name}_{environment}_{timestamp}.sql.gz
   â†“
6. ë°±ì—… íŒŒì¼ í¬ê¸° í™•ì¸
   â†“
7. Slack ì•Œë¦¼ ì „ì†¡ (ì„±ê³µ/ì‹¤íŒ¨)
```

## Celery Beat ìŠ¤ì¼€ì¤„

```python
# backend/resee/celery.py
CELERY_BEAT_SCHEDULE = {
    'daily-database-backup': {
        'task': 'review.backup_tasks.backup_database',
        'schedule': crontab(hour=3, minute=0),  # ë§¤ì¼ ì˜¤ì „ 3ì‹œ
        'args': ['production']  # or 'development'
    }
}
```

## ê´€ë ¨ íŒŒì¼

- `backend/review/backup_tasks.py` - ë°±ì—… Celery ì‘ì—…
- `backend/resee/celery.py` - Celery Beat ìŠ¤ì¼€ì¤„ ì„¤ì •
- `backend/utils/slack_notifications.py` - ë°±ì—… ì•Œë¦¼

## ë°±ì—… ëª…ë ¹ì–´

```bash
# ìˆ˜ë™ ë°±ì—… ì‹¤í–‰
docker-compose exec backend python manage.py shell
>>> from review.backup_tasks import backup_database
>>> backup_database.delay('production')

# ë°±ì—… ìƒíƒœ í™•ì¸
docker-compose exec backend ls -lh /tmp/*.sql.gz
```

## ë°±ì—… íŒŒì¼ í˜•ì‹

```
íŒŒì¼ëª…: resee_prod_production_20251020_030000.sql.gz
- resee_prod: ë°ì´í„°ë² ì´ìŠ¤ ì´ë¦„
- production: í™˜ê²½
- 20251020: ë‚ ì§œ (YYYYMMDD)
- 030000: ì‹œê°„ (HHMMSS)
- .sql.gz: gzip ì••ì¶•ëœ SQL ë¤í”„
```

## Slack ì•Œë¦¼ ì˜ˆì‹œ

**ì„±ê³µ ì‹œ**:
```
âœ… Database backup completed successfully
â€¢ Environment: production
â€¢ File: resee_prod_production_20251020_030000.sql.gz
â€¢ Size: 15.32 MB
```

**ì‹¤íŒ¨ ì‹œ**:
```
ğŸ”´ Database backup failed
â€¢ Environment: production
â€¢ Error: pg_dump: [archiver (db)] connection to database failed
```

## í™˜ê²½ ë³€ìˆ˜

```bash
# .env
DATABASE_URL=postgresql://postgres:password@postgres:5432/resee_prod
SLACK_WEBHOOK_URL=https://hooks.slack.com/...  # ì„ íƒì 
```

## ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

1. **ë¹„ë°€ë²ˆí˜¸ ë…¸ì¶œ ë°©ì§€**: PGPASSWORD í™˜ê²½ë³€ìˆ˜ ì‚¬ìš©
2. **ì ‘ê·¼ ì œì–´**: /tmp/ ë””ë ‰í† ë¦¬ ê¶Œí•œ í™•ì¸
3. **ë°±ì—… ë³´ê´€**: ì •ê¸°ì ìœ¼ë¡œ ì•ˆì „í•œ ì €ì¥ì†Œë¡œ ì´ë™ í•„ìš”
4. **ì•”í˜¸í™”**: ë¯¼ê°í•œ ë°ì´í„° ë°±ì—… ì‹œ ì•”í˜¸í™” ê¶Œì¥
