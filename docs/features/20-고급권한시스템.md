# 고급 권한 시스템

## 핵심 개념

**3개의 커스텀 권한 클래스**로 세밀한 접근 제어를 제공합니다.
이메일 인증, 구독 활성화, AI 기능 접근을 단계별로 검증합니다.

## 주요 기능

- **3개 권한 클래스**:
  - EmailVerifiedRequired: 이메일 인증 필수
  - SubscriptionRequired: 활성 구독 필수
  - AIFeaturesRequired: AI 기능 접근 권한
- **한국어 에러 메시지**: 사용자 친화적 응답
- **Django REST Framework 통합**: permission_classes 데코레이터 사용
- **세밀한 접근 제어**: 엔드포인트별 권한 설정

## 동작 흐름

```
[이메일 인증 검증]
1. 사용자가 콘텐츠 생성 요청
   ↓
2. EmailVerifiedRequired 권한 체크
   ↓
3. request.user.is_authenticated 확인
   ↓
4. request.user.is_email_verified 확인
   ↓
5. 미인증 시 403 응답
   - {"detail": "이메일 인증이 필요합니다."}

[구독 검증]
1. 사용자가 주간 시험 요청
   ↓
2. SubscriptionRequired 권한 체크
   ↓
3. 인증 여부 확인
   ↓
4. subscription 속성 존재 확인
   ↓
5. subscription.is_active 확인
   ↓
6. 비활성 시 403 응답

[AI 기능 검증]
1. 사용자가 AI 문제 생성 요청
   ↓
2. AIFeaturesRequired 권한 체크
   ↓
3. can_use_ai_features() 메서드 호출
   ↓
4. 구독 등급 및 AI 사용 가능 여부 확인
   ↓
5. 불가 시 403 응답
```

## 사용 예시

```python
from rest_framework.views import APIView
from rest_framework.permissions import IsAuthenticated
from resee.permissions import EmailVerifiedRequired, AIFeaturesRequired

# 이메일 인증 필수
class ContentCreateView(APIView):
    permission_classes = [IsAuthenticated, EmailVerifiedRequired]

    def post(self, request):
        # 이메일 인증된 사용자만 접근 가능
        pass

# AI 기능 필수
class QuestionGenerationView(APIView):
    permission_classes = [IsAuthenticated, AIFeaturesRequired]

    def post(self, request):
        # AI 기능 사용 가능한 사용자만 접근
        pass

# 여러 권한 조합
class WeeklyTestView(APIView):
    permission_classes = [
        IsAuthenticated,
        EmailVerifiedRequired,
        SubscriptionRequired
    ]

    def post(self, request):
        # 인증 + 이메일 인증 + 활성 구독 필요
        pass
```

## 권한 클래스 상세

### 1. EmailVerifiedRequired
- **목적**: 이메일 인증 강제
- **확인 사항**:
  - request.user.is_authenticated
  - request.user.is_email_verified
- **에러 메시지**: "이메일 인증이 필요합니다."

### 2. SubscriptionRequired
- **목적**: 활성 구독 강제
- **확인 사항**:
  - request.user.is_authenticated
  - hasattr(request.user, 'subscription')
  - request.user.subscription.is_active
- **에러 메시지**: "구독이 필요한 기능입니다."

### 3. AIFeaturesRequired
- **목적**: AI 기능 접근 제어
- **확인 사항**:
  - request.user.is_authenticated
  - request.user.can_use_ai_features()
- **에러 메시지**: "AI 기능을 사용할 수 없습니다. 구독을 확인해주세요."

## can_use_ai_features() 메서드

```python
# backend/accounts/models.py
class User(AbstractBaseUser):
    def can_use_ai_features(self):
        """AI 기능 사용 가능 여부"""
        if not hasattr(self, 'subscription'):
            return False

        # FREE 티어는 AI 기능 제한 가능
        if self.subscription.tier == 'free':
            return False  # 또는 제한적 허용

        return self.subscription.is_active
```

## 관련 파일

- `backend/resee/permissions.py` - 3개 권한 클래스
- `backend/accounts/models.py` - User.can_use_ai_features()

## 403 응답 예시

**이메일 미인증**:
```json
{
  "detail": "이메일 인증이 필요합니다."
}
```

**구독 없음**:
```json
{
  "detail": "구독이 필요한 기능입니다."
}
```

**AI 기능 불가**:
```json
{
  "detail": "AI 기능을 사용할 수 없습니다. 구독을 확인해주세요."
}
```

## 엔드포인트별 권한 적용

```python
# 콘텐츠 생성 - 이메일 인증 필수
POST /api/content/
→ [IsAuthenticated, EmailVerifiedRequired]

# 복습 제출 - 이메일 인증 필수
POST /api/review/{id}/submit/
→ [IsAuthenticated, EmailVerifiedRequired]

# 주간 시험 - 구독 필수
POST /api/weekly-test/
→ [IsAuthenticated, SubscriptionRequired]

# AI 문제 생성 - AI 기능 필수
POST /api/weekly-test/generate/
→ [IsAuthenticated, AIFeaturesRequired]
```

## 권한 체크 순서

DRF는 permission_classes를 순서대로 검사합니다:
```python
permission_classes = [
    IsAuthenticated,        # 1. 인증 확인
    EmailVerifiedRequired,  # 2. 이메일 인증
    SubscriptionRequired    # 3. 구독 확인
]
```

하나라도 실패하면 즉시 403 응답을 반환합니다.

## 커스텀 권한 확장

새로운 권한 클래스 추가 방법:

```python
from rest_framework.permissions import BasePermission

class PremiumOnlyPermission(BasePermission):
    """PRO 구독 전용 권한"""
    message = "PRO 구독자만 사용 가능한 기능입니다."

    def has_permission(self, request, view):
        return (
            request.user.is_authenticated and
            hasattr(request.user, 'subscription') and
            request.user.subscription.tier == 'PRO'
        )
```

## has_object_permission

객체 레벨 권한 검증:

```python
class IsOwner(BasePermission):
    """객체 소유자만 접근 가능"""
    message = "본인의 콘텐츠만 수정할 수 있습니다."

    def has_object_permission(self, request, view, obj):
        return obj.author == request.user
```

## 확장 가능성

추가 가능한 권한:
- 관리자 전용 권한 (IsAdminUser 확장)
- 특정 구독 등급 전용 권한
- IP 기반 접근 제어
- 시간대별 접근 제어
- 디바이스 제한 권한
