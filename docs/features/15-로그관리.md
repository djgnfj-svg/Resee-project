# 로그 관리

## 핵심 개념

**구조화된 JSON 로깅 시스템**으로 4개의 분리된 로그 파일을 관리합니다.
RotatingFileHandler로 로그 파일 크기를 제한하고, 관리자 전용 API로 로그를 조회할 수 있습니다.

## 주요 기능

- **4개 로그 파일**:
  - django.log: 일반 애플리케이션 로그
  - celery.log: Celery 백그라운드 작업
  - security.log: 인증/권한 관련 이벤트
  - error.log: 에러만 기록
- **로그 로테이션**:
  - 파일당 최대 10MB
  - 최대 5개 백업 파일 유지
  - 자동으로 오래된 로그 삭제
- **로그 조회 API**:
  - 로그 요약 (파일 크기, 라인 수)
  - 최근 에러 조회
  - 로그 파일 내용 조회 (관리자 전용)

## 동작 흐름

```
[로그 기록]
1. 애플리케이션에서 logger.info/error 호출
   ↓
2. 로그 레벨에 따라 파일 선택
   - INFO/DEBUG → django.log
   - ERROR → error.log + django.log
   - Celery → celery.log
   - 인증/보안 → security.log
   ↓
3. RotatingFileHandler로 파일 작성
   ↓
4. 10MB 초과 시 로그 로테이션 (backup.1, backup.2 ...)

[로그 조회]
1. 관리자가 GET /api/accounts/logs/summary/ 호출
   ↓
2. 4개 로그 파일 정보 수집
   ↓
3. 파일 크기, 라인 수, 최근 수정 시간 반환
```

## API

- `GET /api/accounts/logs/summary/` - 로그 요약 (관리자)
- `GET /api/accounts/logs/errors/` - 최근 에러 (관리자, 최대 100줄)
- `GET /api/accounts/logs/{log_type}/` - 로그 파일 내용 (관리자)

## 로그 파일 구조

```
logs/
├── django.log           # 일반 로그 (최대 10MB, 5 백업)
├── celery.log           # Celery 작업 로그
├── security.log         # 인증/보안 로그
└── error.log            # 에러만 기록
```

## 로그 레벨

```python
# Django 기본 로그 레벨
LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'verbose': {
            'format': '{levelname} {asctime} {module} {message}',
            'style': '{',
        },
    },
    'handlers': {
        'django_file': {
            'level': 'INFO',
            'class': 'logging.handlers.RotatingFileHandler',
            'filename': 'logs/django.log',
            'maxBytes': 1024 * 1024 * 10,  # 10MB
            'backupCount': 5,
            'formatter': 'verbose',
        },
        'error_file': {
            'level': 'ERROR',
            'class': 'logging.handlers.RotatingFileHandler',
            'filename': 'logs/error.log',
            'maxBytes': 1024 * 1024 * 10,
            'backupCount': 5,
            'formatter': 'verbose',
        },
        'security_file': {
            'level': 'WARNING',
            'class': 'logging.handlers.RotatingFileHandler',
            'filename': 'logs/security.log',
            'maxBytes': 1024 * 1024 * 10,
            'backupCount': 5,
            'formatter': 'verbose',
        },
        'celery_file': {
            'level': 'INFO',
            'class': 'logging.handlers.RotatingFileHandler',
            'filename': 'logs/celery.log',
            'maxBytes': 1024 * 1024 * 10,
            'backupCount': 5,
            'formatter': 'verbose',
        },
    },
    'loggers': {
        'django': {
            'handlers': ['django_file', 'error_file'],
            'level': 'INFO',
            'propagate': True,
        },
        'django.security': {
            'handlers': ['security_file'],
            'level': 'WARNING',
            'propagate': False,
        },
        'celery': {
            'handlers': ['celery_file'],
            'level': 'INFO',
            'propagate': False,
        },
    },
}
```

## 구조화된 로깅 유틸리티

```python
# backend/resee/structured_logging.py

# AI 로깅
from resee.structured_logging import ai_logger

ai_logger.log_question_generation(
    user_id=1,
    content_id=5,
    question_types=['multiple_choice'],
    count=5,
    success=True,
    generated_count=5,
    subscription_tier='PRO',
    processing_time_ms=1250.5
)

# 사용자 액션 로깅
from resee.structured_logging import log_user_action

log_user_action(
    action='review_submitted',
    user_id=1,
    metadata={'score': 85, 'interval_index': 3}
)

# 성능 로깅 데코레이터
from resee.structured_logging import log_performance

@log_performance('calculate_next_review_date')
def calculate_next_review_date(user, interval_index):
    # 함수 로직
    pass
```

## 관련 파일

- `backend/resee/structured_logging.py` - 로깅 유틸리티
- `backend/accounts/health/log_views.py` - 로그 조회 API
- `backend/resee/settings/base.py` - 로깅 설정

## 로그 조회 예시

**로그 요약 조회**:
```bash
GET /api/accounts/logs/summary/

Response:
{
  "django": {
    "size_mb": 8.5,
    "line_count": 125000,
    "last_modified": "2025-10-20T14:30:00Z"
  },
  "celery": {
    "size_mb": 2.3,
    "line_count": 35000,
    "last_modified": "2025-10-20T14:25:00Z"
  },
  "security": {
    "size_mb": 0.8,
    "line_count": 12000,
    "last_modified": "2025-10-20T14:20:00Z"
  },
  "error": {
    "size_mb": 1.2,
    "line_count": 18000,
    "last_modified": "2025-10-20T14:15:00Z"
  }
}
```

**최근 에러 조회**:
```bash
GET /api/accounts/logs/errors/

Response:
{
  "errors": [
    "ERROR 2025-10-20 14:30:15 review Connection to database failed",
    "ERROR 2025-10-20 14:25:00 celery Task review.tasks.send_reminder failed",
    ...
  ],
  "count": 25
}
```

## 보안 고려사항

1. **관리자 전용**: 로그 조회 API는 IsAdminUser 권한 필요
2. **민감 정보 필터링**: 비밀번호, API 키 등 로그에 기록 금지
3. **로그 로테이션**: 디스크 공간 관리
4. **백업 제한**: 최대 5개 백업 파일로 제한
