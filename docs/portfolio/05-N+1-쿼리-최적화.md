# N+1 쿼리 최적화 - 쿼리 99% 감소

> **핵심 성과**: 쿼리 수 **301개 → 1개 (99.7% 감소)**, 응답 시간 **500ms → 50ms**

---

## 한 줄 요약

반복문에서 발생하는 중복 쿼리를 JOIN으로 한 번에 조회

---

## 배경

ReviewScheduleViewSet에서 리스트 조회 시 Django Debug Toolbar로 확인한 결과, 데이터 100개 기준으로 301개의 쿼리가 발생했다.
반복문에서 `schedule.content`, `schedule.content.category`, `schedule.user` 접근 시마다 개별 쿼리가 실행되는 전형적인 N+1 문제였다.
재사용 가능한 Mixin 패턴으로 모든 ViewSet에 일관되게 적용했다.

---

## 문제

반복문에서 관계 필드 접근 시마다 개별 쿼리 발생 - 총 301개

```python
# backend/review/views.py (개선 전)
class ReviewScheduleViewSet(viewsets.ModelViewSet):
    queryset = ReviewSchedule.objects.all()

    def list(self, request):
        schedules = ReviewSchedule.objects.filter(user=request.user)  # 1번

        for schedule in schedules:  # 100번 반복
            schedule.content.title      # 쿼리 1번 (Lazy Loading)
            schedule.content.category   # 쿼리 1번
            schedule.user.email         # 쿼리 1번

# 총 301개 쿼리: 1 + (100 × 3) = 301
```

---

## 해결

### Before → After

#### 1. Mixin 패턴 (재사용)

```python
# backend/resee/mixins.py:99-118
class OptimizedQueryMixin:
    select_related_fields = []
    prefetch_related_fields = []

    def get_queryset(self):
        queryset = super().get_queryset()
        if self.select_related_fields:
            queryset = queryset.select_related(*self.select_related_fields)
        if self.prefetch_related_fields:
            queryset = queryset.prefetch_related(*self.prefetch_related_fields)
        return queryset
```

#### 2. ViewSet 적용 (2줄 추가)

```python
# backend/review/views.py:35-39
class ReviewScheduleViewSet(OptimizedQueryMixin, viewsets.ModelViewSet):
    queryset = ReviewSchedule.objects.all()
    serializer_class = ReviewScheduleSerializer

    # 이 두 줄만 추가
    select_related_fields = ['content', 'content__category', 'user']
    prefetch_related_fields = []
```

**실행되는 SQL**:
```sql
-- 단 1개 쿼리 (JOIN)
SELECT
    review_reviewschedule.*,
    content_content.*,
    content_category.*,
    accounts_user.*
FROM review_reviewschedule
INNER JOIN content_content ON ...
INNER JOIN content_category ON ...
INNER JOIN accounts_user ON ...
WHERE user_id = 1;
```

---

## 성과

| 지표 | Before | After | 개선 |
|-----|--------|-------|------|
| **쿼리 수** (100개 데이터) | 301개 | 1개 | **99.7% 감소** |
| **응답 시간** | 500ms | 50ms | **90% 개선** |

---

## 코드 위치

```
backend/resee/mixins.py        # OptimizedQueryMixin
backend/review/views.py        # ReviewScheduleViewSet
backend/content/views.py       # ContentViewSet
```

**핵심 로직 (2줄)**:
```python
queryset = queryset.select_related('fk1', 'fk2__nested')  # ForeignKey
queryset = queryset.prefetch_related('m2m')                # ManyToMany
```

---

**작성일**: 2025-10-21
**키워드**: N+1 Problem, select_related, Django ORM
