# 🚀 Resee 배포하기 (완전판)

> **이 파일 하나만 따라하면 배포 완료!** ⏱️ 총 90분 소요

---

## 🎯 준비물 (10분)

### 필수 준비사항
- [ ] **서버**: Ubuntu 20.04+ (AWS EC2, 디지털오션 등)
- [ ] **도메인**: yourdomain.com 구매 및 서버 IP로 DNS 설정
- [ ] **Google OAuth**: [Google Console](https://console.cloud.google.com/)에서 앱 등록
- [ ] **이메일 서비스**: AWS SES 또는 Gmail SMTP 계정

---

## 🔧 1단계: 서버 설정 (30분)

### 서버 접속 후 한 번에 설치
```bash
# 서버 환경 자동 설치 (복사해서 한 번에 실행)
sudo apt update && sudo apt upgrade -y
sudo apt install -y curl git nginx certbot python3-certbot-nginx ufw htop

# Docker 설치
curl -fsSL https://get.docker.com -o get-docker.sh && sudo sh get-docker.sh
sudo usermod -aG docker $USER

# Docker Compose 설치
sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# 방화벽 설정
sudo ufw default deny incoming && sudo ufw default allow outgoing
sudo ufw allow ssh && sudo ufw allow http && sudo ufw allow https
sudo ufw --force enable

# 디렉토리 생성
sudo mkdir -p /opt/Resee /var/log/resee /backups
sudo chown -R $USER:$USER /opt/Resee /var/log/resee /backups

echo "✅ 서버 설정 완료! 터미널을 다시 시작하세요."
```

**🔄 터미널 재시작 또는 `newgrp docker` 실행**

---

## 📥 2단계: 소스코드 다운로드 (5분)

```bash
# 소스코드 다운로드
cd /opt
git clone https://github.com/your-username/Resee.git  # 본인 저장소 주소로 변경
cd Resee
```

---

## ⚙️ 3단계: 환경설정 (15분) ⚠️ 가장 중요!

### 환경변수 파일 생성
```bash
# 환경변수 파일 복사 및 수정
cp .env.production.example .env.production
nano .env.production
```

### 📝 .env.production 파일에서 반드시 수정할 것들:

```env
# 🔑 보안 키 (반드시 변경!)
SECRET_KEY=django-insecure-바꿔주세요-50자-이상-랜덤-문자열
POSTGRES_PASSWORD=데이터베이스-강한-비밀번호
RABBITMQ_PASSWORD=큐-강한-비밀번호

# 🌐 도메인 설정 (본인 도메인으로 변경)
ALLOWED_HOSTS=yourdomain.com,www.yourdomain.com
CORS_ALLOWED_ORIGINS=https://yourdomain.com,https://www.yourdomain.com
CSRF_TRUSTED_ORIGINS=https://yourdomain.com,https://www.yourdomain.com
REACT_APP_API_URL=https://yourdomain.com/api

# 🔒 HTTPS 설정
SECURE_SSL_REDIRECT=True
SESSION_COOKIE_SECURE=True
CSRF_COOKIE_SECURE=True

# 🔐 Google OAuth (Google Console에서 발급받은 것)
GOOGLE_OAUTH2_CLIENT_ID=본인-구글-클라이언트-ID
GOOGLE_OAUTH2_CLIENT_SECRET=본인-구글-클라이언트-시크릿
REACT_APP_GOOGLE_CLIENT_ID=본인-구글-클라이언트-ID

# 📧 이메일 설정 (AWS SES 사용시)
EMAIL_BACKEND=django_ses.SESBackend
AWS_ACCESS_KEY_ID=본인-AWS-키
AWS_SECRET_ACCESS_KEY=본인-AWS-시크릿
DEFAULT_FROM_EMAIL=noreply@yourdomain.com

# 📧 이메일 설정 (Gmail SMTP 사용시 - 위 대신 사용)
# EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend
# EMAIL_HOST=smtp.gmail.com
# EMAIL_PORT=587
# EMAIL_USE_TLS=True
# EMAIL_HOST_USER=본인이메일@gmail.com
# EMAIL_HOST_PASSWORD=앱-비밀번호
# DEFAULT_FROM_EMAIL=noreply@yourdomain.com

# 🤖 AI 기능 (선택사항)
ANTHROPIC_API_KEY=본인-앤트로픽-API-키
```

### 🔑 보안 키 생성 도구
```bash
# Django SECRET_KEY 생성
python3 -c "from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())"

# 강한 비밀번호 생성
openssl rand -base64 32
```

---

## 🔐 4단계: SSL 인증서 발급 (10분)

### 도메인 연결 확인
```bash
# 도메인이 서버를 가리키는지 확인
ping yourdomain.com  # 본인 도메인으로 변경
```

### SSL 인증서 자동 발급
```bash
# Let's Encrypt 인증서 발급
sudo certbot --nginx -d yourdomain.com -d www.yourdomain.com  # 본인 도메인으로 변경

# 자동 갱신 설정
echo "0 12 * * * /usr/bin/certbot renew --quiet" | sudo crontab -
```

---

## 🚢 5단계: 애플리케이션 배포 (25분)

### Docker 이미지 빌드 및 실행
```bash
cd /opt/Resee

# 1. 이미지 빌드 (5분)
docker-compose -f docker-compose.production.yml build

# 2. 데이터베이스 서비스만 먼저 시작 (2분)
docker-compose -f docker-compose.production.yml up -d db redis rabbitmq

# 3. 30초 대기 후 데이터베이스 초기화 (3분)
sleep 30
docker-compose -f docker-compose.production.yml run --rm backend python manage.py migrate
docker-compose -f docker-compose.production.yml run --rm backend python manage.py collectstatic --noinput

# 4. 관리자 계정 생성 (2분)
docker-compose -f docker-compose.production.yml run --rm backend python manage.py createsuperuser

# 5. 전체 서비스 시작 (3분)
docker-compose -f docker-compose.production.yml up -d

# 6. 서비스 상태 확인
docker-compose -f docker-compose.production.yml ps
```

### Nginx 설정
```bash
# Nginx 설정 백업 및 적용
sudo cp /etc/nginx/nginx.conf /etc/nginx/nginx.conf.backup
sudo cp config/nginx.production.conf /etc/nginx/nginx.conf

# 도메인 변경 (본인 도메인으로)
sudo sed -i 's/yourdomain.com/실제도메인.com/g' /etc/nginx/nginx.conf

# 설정 테스트 및 재시작
sudo nginx -t && sudo systemctl restart nginx
```

---

## ✅ 6단계: 배포 완료 확인 (5분)

### 웹사이트 동작 확인
```bash
# HTTP → HTTPS 리다이렉션 확인
curl -I http://yourdomain.com

# HTTPS 동작 확인
curl -I https://yourdomain.com

# API 상태 확인
curl https://yourdomain.com/api/health/
```

### 브라우저에서 확인할 것들
- [ ] **메인 페이지**: https://yourdomain.com 접속 확인
- [ ] **회원가입**: 이메일 회원가입 테스트
- [ ] **Google 로그인**: Google OAuth 로그인 테스트
- [ ] **콘텐츠 생성**: 학습 콘텐츠 생성 테스트
- [ ] **복습 기능**: 복습 페이지 동작 확인
- [ ] **관리자 페이지**: https://yourdomain.com/admin/ 접속 확인

---

## 🔧 자동 백업 설정 (선택사항)

### 데이터베이스 자동 백업
```bash
# 백업 스크립트 실행 권한 부여
chmod +x scripts/backup_db.sh

# 매일 새벽 2시 자동 백업 설정
crontab -e
# 다음 줄 추가:
0 2 * * * /opt/Resee/scripts/backup_db.sh >> /var/log/resee/backup.log 2>&1
```

---

## 🚨 문제 해결

### 컨테이너가 시작되지 않을 때
```bash
# 로그 확인
docker-compose -f docker-compose.production.yml logs 문제된컨테이너명

# 전체 재시작
docker-compose -f docker-compose.production.yml down
docker-compose -f docker-compose.production.yml up -d
```

### SSL 문제
```bash
# 인증서 갱신
sudo certbot renew
sudo systemctl restart nginx
```

### 환경변수 문제
```bash
# 환경변수 파일 확인
cat .env.production | grep -v '^#' | grep -v '^$'

# 특정 값 확인
grep "SECRET_KEY\|GOOGLE_OAUTH2\|POSTGRES" .env.production
```

### 정적파일 문제 (CSS/JS 안 로드)
```bash
# 정적파일 재수집
docker-compose -f docker-compose.production.yml exec backend python manage.py collectstatic --noinput
sudo systemctl restart nginx
```

### 데이터베이스 연결 문제
```bash
# DB 컨테이너 상태 확인
docker-compose -f docker-compose.production.yml ps db

# DB 연결 테스트
docker-compose -f docker-compose.production.yml exec backend python manage.py dbshell
```

---

## 🎉 배포 완료!

### ✅ 성공하면 이런 것들이 동작해야 합니다:
- https://yourdomain.com → 메인 페이지 로드
- 회원가입/로그인 기능
- Google OAuth 로그인
- 콘텐츠 생성 및 복습 기능
- 관리자 페이지 접속

### 📱 추가 설정 (선택사항)
- **모니터링**: 시스템 상태를 정기적으로 체크
- **알림**: 서버 문제 발생 시 알림 받기
- **스케일링**: 트래픽 증가 시 서버 증설

### 🔄 정기 관리
- **일일**: `docker-compose logs --tail=50` 로그 확인
- **주간**: `ls -la /backups/postgresql/` 백업 확인
- **월간**: `sudo apt update && sudo apt upgrade` 보안 업데이트

---

## 🆘 도움이 필요하면

### Claude에게 안전하게 도움 요청하기
```bash
# 민감하지 않은 정보만 공유하세요
echo "ENVIRONMENT=production" > .env.claude
echo "DEBUG=False" >> .env.claude
echo "POSTGRES_DB=resee_production" >> .env.claude

# 에러 로그 (개인정보 제거)
docker-compose logs backend | grep -v -E "(password|secret|key)" | tail -50
```

### 절대 공유하면 안 되는 것
- ❌ SECRET_KEY
- ❌ 데이터베이스 비밀번호
- ❌ API 키들
- ❌ 사용자 데이터

### 공유해도 되는 것
- ✅ 에러 로그 (개인정보 제거된)
- ✅ Docker compose 설정
- ✅ Nginx 설정
- ✅ 일반적인 환경 설정

---

**🚀 이제 Resee가 프로덕션에서 실행됩니다!**

> 💡 **팁**: 이 문서를 북마크해두고 배포할 때마다 체크리스트로 사용하세요!