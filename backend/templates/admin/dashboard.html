{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}{{ title }} | {{ site_title|default:"Django site admin" }}{% endblock %}

{% block extrastyle %}
    {{ block.super }}
    <style>
        .dashboard-container {
            padding: 20px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .metric-card h3 {
            margin: 0 0 12px 0;
            font-size: 15px;
            font-weight: bold;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-value {
            font-size: 48px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            line-height: 1;
        }

        .metric-change {
            font-size: 12px;
            margin-left: 5px;
        }

        .metric-change.positive {
            color: #28a745;
        }

        .metric-change.negative {
            color: #dc3545;
        }

        .metric-subtitle {
            font-size: 13px;
            color: #666;
            font-weight: 500;
        }

        .dashboard-section {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 18px;
            padding-bottom: 12px;
            border-bottom: 2px solid #ddd;
            color: #222;
        }

        .metric-card.warning {
            border-left: 4px solid #ff9800;
        }

        .metric-card.danger {
            border-left: 4px solid #f44336;
        }

        .metric-card.success {
            border-left: 4px solid #4caf50;
        }

        .activity-item, .alert-item {
            padding: 10px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .activity-item:last-child, .alert-item:last-child {
            border-bottom: none;
        }

        .activity-type, .alert-type {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .activity-type {
            background: #e3f2fd;
            color: #1976d2;
        }

        .alert-type.info {
            background: #e3f2fd;
            color: #1976d2;
        }

        .alert-type.warning {
            background: #fff3e0;
            color: #f57c00;
        }

        .alert-type.error {
            background: #ffebee;
            color: #d32f2f;
        }

        .timestamp {
            font-size: 11px;
            color: #999;
        }

        .tier-distribution {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .tier-item {
            text-align: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            min-width: 80px;
        }

        .tier-count {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .tier-label {
            font-size: 13px;
            color: #444;
            text-transform: uppercase;
            font-weight: 600;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: #28a745;
            transition: width 0.3s ease;
        }

        .top-users {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .user-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .user-item {
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
        }

        .user-item:last-child {
            border-bottom: none;
        }

        .refresh-button {
            background: #007cba;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .refresh-button:hover {
            background: #005a87;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 8px;
            animation: pulse 2s infinite;
        }

        .status-indicator.online {
            background-color: #28a745;
        }

        .status-indicator.warning {
            background-color: #ffc107;
        }

        .status-indicator.offline {
            background-color: #dc3545;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .system-health-details {
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px solid #f0f0f0;
        }


        @media (max-width: 768px) {
            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .top-users {
                grid-template-columns: 1fr;
            }
        }
    </style>
{% endblock %}

{% block content %}

<div class="dashboard-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Resee 관리자 대시보드</h1>
        <button class="refresh-button" onclick="refreshDashboard()">데이터 새로고침</button>
    </div>

    <!-- Key Metrics -->
    <div class="metrics-grid">
        <!-- Total Users -->
        <div class="metric-card">
            <h3>전체 사용자</h3>
            <div class="metric-value">{{ user_metrics.total_users|default:0 }}</div>
            <div class="metric-subtitle">
                이번 주 신규 가입: {{ user_metrics.new_week|default:0 }}명
                <br>인증률: {{ user_metrics.verified_rate|floatformat:1 }}%
            </div>
        </div>

        <!-- Today's New Users -->
        <div class="metric-card {% if user_metrics.new_today > 0 %}success{% endif %}">
            <h3>오늘 신규 가입</h3>
            <div class="metric-value">{{ user_metrics.new_today|default:0 }}</div>
            <div class="metric-subtitle">
                오늘 가입한 사용자 수
            </div>
        </div>

        <!-- Unverified Users -->
        <div class="metric-card {% if user_metrics.unverified_users > 5 %}warning{% elif user_metrics.unverified_users > 10 %}danger{% endif %}">
            <h3>미인증 사용자</h3>
            <div class="metric-value">{{ user_metrics.unverified_users|default:0 }}</div>
            <div class="metric-subtitle">
                이메일 미인증 사용자
                {% if user_metrics.unverified_users > 5 %}<br><strong style="color: #ff9800;">⚠️ 확인 필요</strong>{% endif %}
            </div>
        </div>

        <!-- Total Content -->
        <div class="metric-card">
            <h3>전체 콘텐츠</h3>
            <div class="metric-value">{{ content_metrics.total_content|default:0 }}</div>
            <div class="metric-subtitle">
                이번 주 생성: {{ content_metrics.content_week|default:0 }}개
                <br>총 복습 횟수: {{ content_metrics.total_reviews|default:0 }}회
            </div>
        </div>

        <!-- Reviews Due Today -->
        <div class="metric-card {% if review_metrics.due_today > 50 %}warning{% elif review_metrics.due_today > 100 %}danger{% endif %}">
            <h3>오늘 복습 예정</h3>
            <div class="metric-value">{{ review_metrics.due_today|default:0 }}</div>
            <div class="metric-subtitle">
                오늘 복습해야 할 콘텐츠
                {% if review_metrics.due_today > 50 %}<br><strong style="color: #ff9800;">⚠️ 서버 부하 주의</strong>{% endif %}
            </div>
        </div>

        <!-- Expiring Subscriptions -->
        <div class="metric-card {% if subscription_metrics.expiring_soon > 0 %}warning{% endif %}">
            <h3>구독 만료 임박</h3>
            <div class="metric-value">{{ subscription_metrics.expiring_soon|default:0 }}</div>
            <div class="metric-subtitle">
                7일 이내 만료 예정
                {% if subscription_metrics.expiring_soon > 0 %}<br><strong style="color: #ff9800;">⚠️ 리텐션 관리 필요</strong>{% endif %}
            </div>
        </div>
    </div>

    <!-- Subscription Tier Distribution -->
    <div class="dashboard-section">
        <div class="section-title">구독 등급 분포</div>
        <div class="tier-distribution">
            {% for tier_label, count in tier_distribution.items %}
            <div class="tier-item">
                <div class="tier-count">{{ count }}</div>
                <div class="tier-label">{{ tier_label }}</div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- System Health -->
    <div class="dashboard-section">
        <div class="section-title">시스템 상태</div>
        <div style="display: flex; gap: 20px; flex-wrap: wrap; font-size: 16px;">
            <div>
                <strong style="color: #333;">데이터베이스:</strong>
                <span class="status-indicator {% if system_health.database %}online{% else %}offline{% endif %}"></span>
                <span style="color: #333;">{% if system_health.database %}정상{% else %}오프라인{% endif %}</span>
            </div>
            <div>
                <strong style="color: #333;">Redis 캐시:</strong>
                <span class="status-indicator {% if system_health.redis %}online{% else %}offline{% endif %}"></span>
                <span style="color: #333;">{% if system_health.redis %}정상{% else %}오프라인{% endif %}</span>
            </div>
            <div>
                <strong style="color: #333;">Celery:</strong>
                <span class="status-indicator {% if system_health.celery %}online{% else %}offline{% endif %}"></span>
                <span style="color: #333;">{% if system_health.celery %}정상{% else %}오프라인{% endif %}</span>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="dashboard-section">
        <div class="section-title">최근 활동</div>
        {% for activity in recent_activity %}
        <div class="activity-item">
            <div>
                <span class="activity-type">{{ activity.type }}</span>
                <span class="ml-2">{{ activity.description }}</span>
            </div>
            <div class="timestamp">{{ activity.timestamp|date:"m월 d일, H:i" }}</div>
        </div>
        {% empty %}
        <p class="text-muted">최근 활동이 없습니다</p>
        {% endfor %}
    </div>

    <!-- Quick Actions -->
    <div class="dashboard-section">
        <div class="section-title">빠른 작업</div>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <a href="{% url 'admin:accounts_user_changelist' %}" class="btn btn-primary">사용자 관리</a>
            <a href="{% url 'admin:accounts_subscription_changelist' %}" class="btn btn-secondary">구독 관리</a>
            <a href="{% url 'admin:content_content_changelist' %}" class="btn btn-secondary">콘텐츠 관리</a>
            <a href="{% url 'admin:review_reviewschedule_changelist' %}" class="btn btn-secondary">복습 일정</a>
            <a href="{% url 'admin:review_reviewhistory_changelist' %}" class="btn btn-secondary">복습 기록</a>
            <a href="{% url 'admin:weekly_test_weeklytest_changelist' %}" class="btn btn-secondary">주간 시험</a>
        </div>
    </div>
</div>

<script>
// Simple refresh function
function refreshDashboard() {
    window.location.reload();
}
</script>
{% endblock %}